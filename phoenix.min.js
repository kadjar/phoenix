(function(){(function(e,t){if(typeof define==="function"&&define.amd){return define(["phoenix"],t)}else if(typeof exports==="object"){return t(exports)}else{return t(e.Phoenix={})}})(this,function(e){e.Channel=function(){function e(e,t,n,r,i){this.channel=e;this.topic=t;this.message=n;this.callback=r;this.socket=i;this.reset()}e.prototype.bindings=null;e.prototype.reset=function(){return this.bindings=[]};e.prototype.on=function(e,t){return this.bindings.push({event:e,callback:t})};e.prototype.isMember=function(e,t){return this.channel===e&&this.topic===t};e.prototype.off=function(e){var t;return this.bindings=function(){var n,r,i,s;i=this.bindings;s=[];for(n=0,r=i.length;n<r;n++){t=i[n];if(t.event!==e){s.push(t)}}return s}.call(this)};e.prototype.trigger=function(e,t){var n,r,i,s,o,u,a;o=this.bindings;a=[];for(i=0,s=o.length;i<s;i++){u=o[i],r=u.event,n=u.callback;if(r===e){a.push(n(t))}}return a};e.prototype.send=function(e,t){return this.socket.send({channel:this.channel,topic:this.topic,event:e,message:t})};e.prototype.leave=function(e){if(e==null){e={}}this.socket.leave(this.channel,this.topic,e);return this.reset()};return e}();e.Socket=function(){function t(e,t){var n;if(t==null){t={}}this.heartbeatIntervalMs=(n=t.heartbeatIntervalMs)!=null?n:this.heartbeatIntervalMs;this.endPoint=this.expandEndpoint(e);this.channels=[];this.sendBuffer=[];this.stateChangeCallbacks={open:[],close:[],error:[]};this.resetBufferTimer();this.reconnect()}t.prototype.conn=null;t.prototype.endPoint=null;t.prototype.channels=null;t.prototype.sendBuffer=null;t.prototype.sendBufferTimer=null;t.prototype.flushEveryMs=50;t.prototype.reconnectTimer=null;t.prototype.reconnectAfterMs=5e3;t.prototype.heartbeatIntervalMs=3e4;t.prototype.stateChangeCallbacks=null;t.prototype.protocol=function(){if(location.protocol.match(/^https/)){return"wss"}else{return"ws"}};t.prototype.expandEndpoint=function(e){if(e.charAt(0)!=="/"){return e}if(e.charAt(1)==="/"){return""+this.protocol()+":"+e}return""+this.protocol()+"://"+location.host+e};t.prototype.close=function(e,t,n){if(this.conn!=null){this.conn.onclose=function(e){return function(){}}(this);if(t!=null){this.conn.close(t,n!=null?n:"")}else{this.conn.close()}this.conn=null}return typeof e==="function"?e():void 0};t.prototype.reconnect=function(){return this.close(function(e){return function(){e.conn=new WebSocket(e.endPoint);e.conn.onopen=function(){return e.onConnOpen()};e.conn.onerror=function(t){return e.onConnError(t)};e.conn.onmessage=function(t){return e.onMessage(t)};return e.conn.onclose=function(t){return e.onConnClose(t)}}}(this))};t.prototype.resetBufferTimer=function(){clearTimeout(this.sendBufferTimer);return this.sendBufferTimer=setTimeout(function(e){return function(){return e.flushSendBuffer()}}(this),this.flushEveryMs)};t.prototype.onOpen=function(e){if(e){return this.stateChangeCallbacks.open.push(e)}};t.prototype.onClose=function(e){if(e){return this.stateChangeCallbacks.close.push(e)}};t.prototype.onError=function(e){if(e){return this.stateChangeCallbacks.error.push(e)}};t.prototype.onConnOpen=function(){var e,t,n,r,i;clearInterval(this.reconnectTimer);this.heartbeatTimer=setInterval(function(e){return function(){return e.sendHeartbeat()}}(this),this.heartbeatIntervalMs);this.rejoinAll();r=this.stateChangeCallbacks.open;i=[];for(t=0,n=r.length;t<n;t++){e=r[t];i.push(e())}return i};t.prototype.onConnClose=function(e){var t,n,r,i,s;if(typeof console.log==="function"){console.log("WS close: ",e)}clearInterval(this.reconnectTimer);clearInterval(this.heartbeatTimer);this.reconnectTimer=setInterval(function(e){return function(){return e.reconnect()}}(this),this.reconnectAfterMs);i=this.stateChangeCallbacks.close;s=[];for(n=0,r=i.length;n<r;n++){t=i[n];s.push(t(e))}return s};t.prototype.onConnError=function(e){var t,n,r,i,s;if(typeof console.log==="function"){console.log("WS error: ",e)}i=this.stateChangeCallbacks.error;s=[];for(n=0,r=i.length;n<r;n++){t=i[n];s.push(t(e))}return s};t.prototype.connectionState=function(){var e;switch((e=this.conn)!=null?e.readyState:void 0){case WebSocket.CONNECTING:return"connecting";case WebSocket.OPEN:return"open";case WebSocket.CLOSING:return"closing";case WebSocket.CLOSED:case null:return"closed"}};t.prototype.isConnected=function(){return this.connectionState()==="open"};t.prototype.rejoinAll=function(){var e,t,n,r,i;r=this.channels;i=[];for(t=0,n=r.length;t<n;t++){e=r[t];i.push(this.rejoin(e))}return i};t.prototype.rejoin=function(e){var t,n,r;e.reset();t=e.channel,r=e.topic,n=e.message;this.send({channel:t,topic:r,event:"join",message:n});return e.callback(e)};t.prototype.join=function(t,n,r,i){var s;s=new e.Channel(t,n,r,i,this);this.channels.push(s);if(this.isConnected()){return this.rejoin(s)}};t.prototype.leave=function(e,t,n){var r;if(n==null){n={}}this.send({channel:e,topic:t,event:"leave",message:n});return this.channels=function(){var n,i,s,o;s=this.channels;o=[];for(n=0,i=s.length;n<i;n++){r=s[n];if(!r.isMember(e,t)){o.push(r)}}return o}.call(this)};t.prototype.send=function(e){var t;t=function(t){return function(){return t.conn.send(JSON.stringify(e))}}(this);if(this.isConnected()){return t()}else{return this.sendBuffer.push(t)}};t.prototype.sendHeartbeat=function(){return this.send({channel:"phoenix",topic:"conn",event:"heartbeat",message:{}})};t.prototype.flushSendBuffer=function(){var e,t,n,r;if(this.isConnected()&&this.sendBuffer.length>0){r=this.sendBuffer;for(t=0,n=r.length;t<n;t++){e=r[t];e()}this.sendBuffer=[]}return this.resetBufferTimer()};t.prototype.onMessage=function(e){var t,n,r,i,s,o,u,a,f,l;if(typeof console.log==="function"){console.log("message received: ",e)}a=JSON.parse(e.data),n=a.channel,s=a.topic,r=a.event,i=a.message;f=this.channels;l=[];for(o=0,u=f.length;o<u;o++){t=f[o];if(t.isMember(n,s)){l.push(t.trigger(r,i))}}return l};return t}();return e})}).call(this)