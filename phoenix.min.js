(function(){(function(e,t){if(typeof define==="function"&&define.amd){return define(["phoenix"],t)}else if(typeof exports==="object"){return t(exports)}else{return t(e.Phoenix={})}})(this,function(e){var t;t=this;e.Channel=function(){function e(e,t,n,r){this.topic=e;this.message=t;this.callback=n;this.socket=r;this.reset()}e.prototype.bindings=null;e.prototype.reset=function(){return this.bindings=[]};e.prototype.on=function(e,t){return this.bindings.push({event:e,callback:t})};e.prototype.isMember=function(e){return this.topic===e};e.prototype.off=function(e){var t;return this.bindings=function(){var n,r,i,s;i=this.bindings;s=[];for(n=0,r=i.length;n<r;n++){t=i[n];if(t.event!==e){s.push(t)}}return s}.call(this)};e.prototype.trigger=function(e,t){var n,r,i,s,o,u,a;o=this.bindings;a=[];for(i=0,s=o.length;i<s;i++){u=o[i],r=u.event,n=u.callback;if(r===e){a.push(n(t))}}return a};e.prototype.send=function(e,t){return this.socket.send({topic:this.topic,event:e,payload:t})};e.prototype.leave=function(e){if(e==null){e={}}this.socket.leave(this.topic,e);return this.reset()};return e}();e.Socket=function(){function n(n,r){var i,s,o,u;if(r==null){r={}}this.states=e.Socket.states;this.transport=(i=(s=r.transport)!=null?s:t.WebSocket)!=null?i:e.LongPoller;this.heartbeatIntervalMs=(o=r.heartbeatIntervalMs)!=null?o:this.heartbeatIntervalMs;this.logger=(u=r.logger)!=null?u:function(){};this.endPoint=this.expandEndpoint(n);this.channels=[];this.sendBuffer=[];this.stateChangeCallbacks={open:[],close:[],error:[],message:[]};this.resetBufferTimer();this.reconnect()}n.states={connecting:0,open:1,closing:2,closed:3};n.prototype.conn=null;n.prototype.endPoint=null;n.prototype.channels=null;n.prototype.sendBuffer=null;n.prototype.sendBufferTimer=null;n.prototype.flushEveryMs=50;n.prototype.reconnectTimer=null;n.prototype.reconnectAfterMs=5e3;n.prototype.heartbeatIntervalMs=3e4;n.prototype.stateChangeCallbacks=null;n.prototype.transport=null;n.prototype.protocol=function(){if(location.protocol.match(/^https/)){return"wss"}else{return"ws"}};n.prototype.expandEndpoint=function(e){if(e.charAt(0)!=="/"){return e}if(e.charAt(1)==="/"){return""+this.protocol()+":"+e}return""+this.protocol()+"://"+location.host+e};n.prototype.close=function(e,t,n){if(this.conn!=null){this.conn.onclose=function(e){return function(){}}(this);if(t!=null){this.conn.close(t,n!=null?n:"")}else{this.conn.close()}this.conn=null}return typeof e==="function"?e():void 0};n.prototype.reconnect=function(){return this.close(function(e){return function(){e.conn=new e.transport(e.endPoint);e.conn.onopen=function(){return e.onConnOpen()};e.conn.onerror=function(t){return e.onConnError(t)};e.conn.onmessage=function(t){return e.onConnMessage(t)};return e.conn.onclose=function(t){return e.onConnClose(t)}}}(this))};n.prototype.resetBufferTimer=function(){clearTimeout(this.sendBufferTimer);return this.sendBufferTimer=setTimeout(function(e){return function(){return e.flushSendBuffer()}}(this),this.flushEveryMs)};n.prototype.log=function(e){return this.logger(e)};n.prototype.onOpen=function(e){if(e){return this.stateChangeCallbacks.open.push(e)}};n.prototype.onClose=function(e){if(e){return this.stateChangeCallbacks.close.push(e)}};n.prototype.onError=function(e){if(e){return this.stateChangeCallbacks.error.push(e)}};n.prototype.onMessage=function(e){if(e){return this.stateChangeCallbacks.message.push(e)}};n.prototype.onConnOpen=function(){var e,t,n,r,i;clearInterval(this.reconnectTimer);if(!this.transport.skipHeartbeat){this.heartbeatTimer=setInterval(function(e){return function(){return e.sendHeartbeat()}}(this),this.heartbeatIntervalMs)}this.rejoinAll();r=this.stateChangeCallbacks.open;i=[];for(t=0,n=r.length;t<n;t++){e=r[t];i.push(e())}return i};n.prototype.onConnClose=function(e){var t,n,r,i,s;this.log("WS close:");this.log(e);clearInterval(this.reconnectTimer);clearInterval(this.heartbeatTimer);this.reconnectTimer=setInterval(function(e){return function(){return e.reconnect()}}(this),this.reconnectAfterMs);i=this.stateChangeCallbacks.close;s=[];for(n=0,r=i.length;n<r;n++){t=i[n];s.push(t(e))}return s};n.prototype.onConnError=function(e){var t,n,r,i,s;this.log("WS error:");this.log(e);i=this.stateChangeCallbacks.error;s=[];for(n=0,r=i.length;n<r;n++){t=i[n];s.push(t(e))}return s};n.prototype.connectionState=function(){var e;switch((e=this.conn)!=null?e.readyState:void 0){case this.states.connecting:return"connecting";case this.states.open:return"open";case this.states.closing:return"closing";case this.states.closed:case null:return"closed"}};n.prototype.isConnected=function(){return this.connectionState()==="open"};n.prototype.rejoinAll=function(){var e,t,n,r,i;r=this.channels;i=[];for(t=0,n=r.length;t<n;t++){e=r[t];i.push(this.rejoin(e))}return i};n.prototype.rejoin=function(e){var t,n;e.reset();n=e.topic,t=e.message;this.send({topic:n,event:"join",payload:t});return e.callback(e)};n.prototype.join=function(t,n,r){var i;i=new e.Channel(t,n,r,this);this.channels.push(i);if(this.isConnected()){return this.rejoin(i)}};n.prototype.leave=function(e,t){var n;if(t==null){t={}}this.send({topic:e,event:"leave",payload:t});return this.channels=function(){var t,r,i,s;i=this.channels;s=[];for(t=0,r=i.length;t<r;t++){n=i[t];if(!n.isMember(e)){s.push(n)}}return s}.call(this)};n.prototype.send=function(e){var t;t=function(t){return function(){return t.conn.send(JSON.stringify(e))}}(this);if(this.isConnected()){return t()}else{return this.sendBuffer.push(t)}};n.prototype.sendHeartbeat=function(){return this.send({topic:"phoenix",event:"heartbeat",payload:{}})};n.prototype.flushSendBuffer=function(){var e,t,n,r;if(this.isConnected()&&this.sendBuffer.length>0){r=this.sendBuffer;for(t=0,n=r.length;t<n;t++){e=r[t];e()}this.sendBuffer=[]}return this.resetBufferTimer()};n.prototype.onConnMessage=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;this.log("message received:");this.log(e);l=JSON.parse(e.data),s=l.topic,r=l.event,i=l.payload;c=this.channels;for(o=0,a=c.length;o<a;o++){n=c[o];if(n.isMember(s)){n.trigger(r,i)}}h=this.stateChangeCallbacks.message;p=[];for(u=0,f=h.length;u<f;u++){t=h[u];p.push(t(s,r,i))}return p};return n}();e.LongPoller=function(){function t(t){this.states=e.Socket.states;this.upgradeEndpoint=this.normalizeEndpoint(t);this.pollEndpoint=this.upgradeEndpoint+(/\/$/.test(t)?"poll":"/poll");this.readyState=this.states.connecting;this.open()}t.prototype.retryInMs=5e3;t.prototype.endPoint=null;t.prototype.skipHeartbeat=true;t.prototype.onopen=function(){};t.prototype.onerror=function(){};t.prototype.onmessage=function(){};t.prototype.onclose=function(){};t.prototype.open=function(){return e.Ajax.request("POST",this.upgradeEndpoint,"application/json",null,function(e){return function(t,n){if(t===200){e.readyState=e.states.open;e.onopen();return e.poll()}else{return e.onerror()}}}(this))};t.prototype.normalizeEndpoint=function(e){return e.replace("ws://","http://").replace("wss://","https://")};t.prototype.poll=function(){if(this.readyState!==this.states.open){return}return e.Ajax.request("GET",this.pollEndpoint,"application/json",null,function(e){return function(t,n){var r,i,s,o;switch(t){case 200:o=JSON.parse(n);for(i=0,s=o.length;i<s;i++){r=o[i];e.onmessage({data:JSON.stringify(r)})}return e.poll();case 204:return e.poll();default:e.close();return setTimeout(function(){return e.open()},e.retryInMs)}}}(this))};t.prototype.send=function(t){return e.Ajax.request("POST",this.pollEndpoint,"application/json",t,function(e){return function(t,n){if(t!==200){return e.onerror()}}}(this))};t.prototype.close=function(e,t){this.readyState=this.states.closed;return this.onclose()};return t}();e.Ajax={states:{complete:4},request:function(e,n,r,i,s){var o;o=t.XMLHttpRequest!=null?new t.XMLHttpRequest:new t.ActiveXObject("Microsoft.XMLHTTP");o.open(e,n,true);o.setRequestHeader("Content-type",r);o.onreadystatechange=function(e){return function(){if(o.readyState===e.states.complete){return typeof s==="function"?s(o.status,o.responseText):void 0}}}(this);return o.send(i)}};return e})}).call(this)